# 主账号、子账号逻辑完善总结

## 1. 小米科技（12分公司）主账号信息

**查询结果：**
- **企业名称**: 小米科技（12分公司）
- **企业ID**: `005a2aaa-3451-404d-b2ba-3a15c43aab92`
- **用户ID**: `2452f751-ebc2-4a5f-a7d8-d2a37ee02824`
- **用户名**: `userb654fac1`
- **是否主账号**: ✅ **True**（是主账号）
- **主账号ID**: `None`（因为是主账号，所以没有主账号ID）
- **子账号数量**: 0（目前没有子账号）

## 2. 主账号、子账号逻辑架构

### 2.1 数据模型

#### 企业端（EnterpriseProfile）
- `is_main_account`: 是否主账号（Boolean）
- `main_account_id`: 主账号ID（String，子账号指向主账号）
- 关系：`main_account` 和 `sub_accounts`（通过 `backref` 自动创建）

#### 教师端（TeacherProfile）
- `is_main_account`: 是否主账号（Boolean）
- `main_account_id`: 主账号ID（String，子账号指向主账号）
- 关系：`main_account` 和 `sub_accounts`（通过 `backref` 自动创建）

#### 学校端（School）
- **不需要主账号、子账号逻辑**
- 学校是实体，不是用户账号
- 教师通过 `school_id` 关联到学校

### 2.2 数据共享逻辑

#### 企业端数据共享规则

1. **主账号**：
   - ✅ 可以查看和管理自己的数据
   - ✅ 可以创建和管理子账号
   - ✅ 可以查看所有子账号创建的数据（通过 `get_enterprise_ids_for_query`）

2. **子账号**：
   - ✅ 可以查看主账号的数据（宣讲会、职位、人才库等）
   - ✅ 创建的数据归属于主账号（使用主账号ID）
   - ❌ 不能创建子账号
   - ⚠️ 不能删除主账号的数据（可以删除自己创建的）

#### 教师端数据共享规则

1. **主账号**：
   - ✅ 可以查看和管理自己的数据
   - ✅ 可以创建和管理子账号

2. **子账号**：
   - ✅ 可以查看主账号的数据
   - ✅ 创建的数据归属于主账号（使用主账号ID）

## 3. 已完善的API功能

### 3.1 宣讲会管理 (`backend/app/api/v1/info_sessions.py`)

| 功能 | 主账号 | 子账号 | 说明 |
|------|--------|--------|------|
| 查看列表 | ✅ | ✅ | 都可以看到主账号的宣讲会 |
| 创建宣讲会 | ✅ | ✅ | 子账号创建时使用主账号ID |
| 更新宣讲会 | ✅ | ✅ | 都可以更新主账号的宣讲会 |
| 删除宣讲会 | ✅ | ✅ | 都可以删除主账号的宣讲会 |
| 邀请学生 | ✅ | ✅ | 都可以邀请学生 |
| 查看报名 | ✅ | ✅ | 都可以查看报名列表 |
| 搜索学生 | ✅ | ✅ | 都可以搜索学生（用于邀请） |

### 3.2 职位管理 (`backend/app/api/v1/jobs.py`)

| 功能 | 主账号 | 子账号 | 说明 |
|------|--------|--------|------|
| 查看列表 | ✅ | ✅ | 都可以看到主账号的职位 |

### 3.3 人才库管理 (`backend/app/api/v1/enterprise_management.py`)

| 功能 | 主账号 | 子账号 | 说明 |
|------|--------|--------|------|
| 查看列表 | ✅ | ✅ | 都可以看到主账号的人才库 |
| 下载简历 | ✅ | ✅ | 都可以下载简历 |

### 3.4 子账号管理 (`backend/app/api/v1/enterprise_management.py`)

| 功能 | 主账号 | 子账号 | 说明 |
|------|--------|--------|------|
| 查看子账号列表 | ✅ | ❌ | 只有主账号可以查看 |
| 创建子账号 | ✅ | ❌ | 只有主账号可以创建 |
| 删除子账号 | ✅ | ❌ | 只有主账号可以删除 |

## 4. 服务层实现

### 4.1 企业服务 (`backend/app/services/enterprise_service.py`)

#### `get_effective_enterprise_id(db, enterprise) -> str`
- **功能**: 获取有效的企业ID
- **逻辑**: 
  - 如果是主账号，返回自己的ID
  - 如果是子账号，返回主账号ID
- **用途**: 用于创建数据时确定归属

#### `get_enterprise_ids_for_query(db, enterprise) -> list[str]`
- **功能**: 获取用于查询的企业ID列表
- **逻辑**:
  - 如果是主账号，返回 `[主账号ID, 子账号1ID, 子账号2ID, ...]`
  - 如果是子账号，返回 `[主账号ID]`
- **用途**: 用于查询数据时包含所有相关企业

#### `can_manage_enterprise_data(enterprise, target_enterprise_id) -> bool`
- **功能**: 检查是否可以管理指定企业的数据
- **用途**: 用于权限验证（预留接口）

## 5. 前端修复

### 5.1 搜索学生功能
- **问题**: 搜索学生时提示"宣讲会不存在"
- **原因**: 前端在搜索时检查了 `currentInviteSessionId.value`，但搜索API不需要session_id
- **修复**: 移除了对 `currentInviteSessionId.value` 的检查，搜索可以独立进行

### 5.2 邀请学生功能
- ✅ 支持按姓名/学号搜索
- ✅ 支持按院系筛选
- ✅ 支持按年级筛选
- ✅ 支持批量邀请（多选学生）

## 6. 使用示例

### 6.1 创建子账号（主账号操作）

```python
# 主账号登录后，调用创建子账号API
POST /api/v1/enterprise-management/sub-accounts
{
  "username": "sub_account_001",
  "password": "password123",
  "real_name": "张三",
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "position": "HR经理"
}
```

### 6.2 子账号查看数据

子账号登录后，调用以下API会自动包含主账号的数据：
- `GET /api/v1/info-sessions` - 查看宣讲会列表（包含主账号的）
- `GET /api/v1/jobs` - 查看职位列表（包含主账号的）
- `GET /api/v1/enterprise-management/talents` - 查看人才库（包含主账号的）

### 6.3 子账号创建数据

子账号创建数据时，会自动使用主账号ID：
- `POST /api/v1/info-sessions` - 创建的宣讲会归属于主账号
- `POST /api/v1/jobs` - 创建的职位归属于主账号

## 7. 数据一致性保证

### 7.1 创建数据时
- 子账号创建数据时，使用 `get_effective_enterprise_id()` 获取主账号ID
- 确保所有数据都归属于主账号

### 7.2 查询数据时
- 使用 `get_enterprise_ids_for_query()` 获取所有相关企业ID
- 主账号可以看到所有子账号的数据
- 子账号只能看到主账号的数据

### 7.3 权限验证
- 更新、删除操作时，使用 `get_effective_enterprise_id()` 验证权限
- 确保主账号和子账号都可以操作主账号的数据

## 8. 修改的文件清单

### 后端文件
1. `backend/app/services/enterprise_service.py` - **新建**，企业服务层
2. `backend/app/api/v1/info_sessions.py` - 完善主账号、子账号逻辑
3. `backend/app/api/v1/jobs.py` - 完善主账号、子账号逻辑
4. `backend/app/api/v1/enterprise_management.py` - 完善人才库查询逻辑
5. `backend/scripts/check_enterprise_main_account.py` - **新建**，查看主账号信息脚本

### 前端文件
1. `frontend/src/views/enterprise/InfoSessions.vue` - 修复搜索学生功能

### 文档文件
1. `MAIN_SUB_ACCOUNT_LOGIC.md` - **新建**，主账号、子账号逻辑说明文档
2. `backend/scripts/improve_main_sub_account_logic.md` - **新建**，完善说明文档

## 9. 测试建议

### 9.1 主账号测试
1. 登录主账号
2. 创建宣讲会、职位
3. 创建子账号
4. 查看子账号列表
5. 查看人才库（应该包含所有数据）

### 9.2 子账号测试
1. 使用子账号登录
2. 查看宣讲会列表（应该看到主账号的宣讲会）
3. 创建新的宣讲会（应该归属于主账号）
4. 查看职位列表（应该看到主账号的职位）
5. 查看人才库（应该看到主账号的人才库）
6. 尝试创建子账号（应该失败）
7. 尝试查看子账号列表（应该失败）

## 10. 注意事项

1. **数据归属**: 子账号创建的所有数据都归属于主账号
2. **权限控制**: 子账号不能创建子账号，不能删除主账号的数据
3. **数据共享**: 主账号和子账号共享数据，但子账号的权限有限
4. **学校模型**: 学校本身不需要主账号、子账号逻辑，因为学校是实体，不是用户账号

## 11. 后续优化建议

1. **权限细化**: 可以添加更细粒度的权限控制（只读、可编辑、可删除等）
2. **数据统计**: 主账号可以查看所有子账号的数据统计
3. **操作日志**: 记录子账号的操作日志，方便主账号审计
4. **批量操作**: 支持批量管理子账号（启用、禁用、删除等）


